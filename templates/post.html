{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}
{% block description %}{{ post.description }}{% endblock %}

{% block content %}
<article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16">
    <!-- Post Header -->
    <header class="mb-10 text-center">
        <div class="flex items-center justify-center gap-3 text-sm text-primary-400 mb-4">
            <span>{{ post.created_at.format("%b %d, %Y") }}</span>
            <span class="text-primary-600">·</span>
            <span>{{ post.reading_time() }} min read</span>
            <span class="text-primary-600">·</span>
            <span>{{ post.views }} views</span>
        </div>

        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-6 leading-tight">
            {{ post.title }}
        </h1>

        <p class="text-lg text-primary-300 max-w-2xl mx-auto mb-6 leading-relaxed">
            {{ post.description }}
        </p>

        <div class="text-primary-400">
            By <span class="text-white font-medium">{{ post.author }}</span>
        </div>

        {% if !post.tags.is_empty() %}
        <div class="flex flex-wrap justify-center gap-2 mt-6">
            {% for tag in post.tags_list() %}
            <span class="text-xs text-primary-300 bg-primary-800 px-3 py-1 rounded-full">
                {{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    <!-- Post Content -->
    <div class="prose prose-invert max-w-none text-base text-primary-200 leading-relaxed mb-12">
        {{ post.html_content|safe }}
    </div>

    <!-- Support Section -->
    <section class="card p-5 max-w-sm mx-auto">
        <p class="text-sm text-primary-300 mb-4 text-center">Support Thoughnuts</p>

        <!-- Currency Selection -->
        <div class="grid grid-cols-4 gap-2 mb-4">
            <button onclick="selectCurrency('eth')" data-currency="eth" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#627EEA"/><path d="M16 4v8.87l7.5 3.35L16 4z" fill="#fff" fill-opacity="0.6"/><path d="M16 4L8.5 16.22l7.5-3.35V4z" fill="#fff"/></svg>
                ETH
            </button>
            <button onclick="selectCurrency('avax')" data-currency="avax" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#E84142"/><path d="M20.5 20h-2.8c-.3 0-.5-.1-.7-.3l-1-1.7-1 1.7c-.2.2-.4.3-.7.3h-2.8c-.4 0-.6-.4-.4-.7l4.2-7.3c.2-.3.6-.3.8 0l4.2 7.3c.2.3 0 .7-.4.7z" fill="#fff"/></svg>
                AVAX
            </button>
            <button onclick="selectCurrency('sol')" data-currency="sol" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#9945FF"/><path d="M9.5 19.2a.6.6 0 01.42-.17h12.53a.3.3 0 01.21.51l-2.54 2.54a.6.6 0 01-.42.17H7.17a.3.3 0 01-.21-.51l2.54-2.54z" fill="#fff"/></svg>
                SOL
            </button>
            <button onclick="selectCurrency('btc')" data-currency="btc" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1">
                <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#F7931A"/><path d="M22.5 13.5c.3-2-1.2-3.1-3.3-3.8l.7-2.7-1.6-.4-.7 2.6c-.4-.1-.8-.2-1.3-.3l.7-2.7-1.6-.4-.7 2.7c-.3-.1-.7-.2-1-.2v-.1l-2.3-.6-.4 1.7s1.2.3 1.2.3c.7.2.8.6.8 1l-.8 3.2c0 .1.1.1.1.1l-.1-.1-1.1 4.5c-.1.2-.3.5-.8.4 0 0-1.2-.3-1.2-.3l-.8 1.9 2.1.5c.4.1.8.2 1.2.3l-.7 2.8 1.6.4.7-2.7c.4.1.9.2 1.3.3l-.7 2.7 1.6.4.7-2.8c2.9.5 5.1.3 6-2.3.7-2.1 0-3.3-1.5-4 1.1-.3 1.9-1 2.1-2.5z" fill="#fff"/></svg>
                BTC
            </button>
            <button onclick="selectCurrency('usdt-eth')" data-currency="usdt-eth" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1 relative">
                <div class="relative">
                    <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#26A17B"/><path d="M17.9 17.9v-2.5h3.3v-2h-3.3v-2.6h-3.8v2.6h-3.3v2h3.3v2.5c-3.7.2-6.5.9-6.5 1.8 0 1 3.4 1.8 7.6 1.8s7.6-.8 7.6-1.8c0-.9-2.8-1.6-6.5-1.8h1.6z" fill="#fff"/></svg>
                    <svg class="w-2.5 h-2.5 absolute -bottom-0.5 -right-0.5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#627EEA"/></svg>
                </div>
                USDT
            </button>
            <button onclick="selectCurrency('usdt-avax')" data-currency="usdt-avax" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1 relative">
                <div class="relative">
                    <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#26A17B"/><path d="M17.9 17.9v-2.5h3.3v-2h-3.3v-2.6h-3.8v2.6h-3.3v2h3.3v2.5c-3.7.2-6.5.9-6.5 1.8 0 1 3.4 1.8 7.6 1.8s7.6-.8 7.6-1.8c0-.9-2.8-1.6-6.5-1.8h1.6z" fill="#fff"/></svg>
                    <svg class="w-2.5 h-2.5 absolute -bottom-0.5 -right-0.5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#E84142"/></svg>
                </div>
                USDT
            </button>
            <button onclick="selectCurrency('usdt-sol')" data-currency="usdt-sol" class="currency-btn btn btn-secondary py-2 px-1 rounded-lg text-xs flex flex-col items-center justify-center gap-1 relative">
                <div class="relative">
                    <svg class="w-5 h-5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#26A17B"/><path d="M17.9 17.9v-2.5h3.3v-2h-3.3v-2.6h-3.8v2.6h-3.3v2h3.3v2.5c-3.7.2-6.5.9-6.5 1.8 0 1 3.4 1.8 7.6 1.8s7.6-.8 7.6-1.8c0-.9-2.8-1.6-6.5-1.8h1.6z" fill="#fff"/></svg>
                    <svg class="w-2.5 h-2.5 absolute -bottom-0.5 -right-0.5" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="#9945FF"/></svg>
                </div>
                USDT
            </button>
        </div>

        <!-- Amount Selection -->
        <div class="grid grid-cols-3 gap-2 mb-3">
            <button onclick="selectAmount(5)" class="amount-btn btn btn-secondary py-2 rounded-lg text-sm">$5</button>
            <button onclick="selectAmount(10)" class="amount-btn btn btn-secondary py-2 rounded-lg text-sm">$10</button>
            <button onclick="selectAmount(20)" class="amount-btn btn btn-secondary py-2 rounded-lg text-sm">$20</button>
        </div>
        <div class="flex gap-2 mb-4">
            <span class="text-primary-400 text-sm py-2">$</span>
            <input type="number" id="customAmount" min="1" placeholder="Custom" class="flex-1 p-2 bg-primary-800 border border-primary-700 rounded-lg text-white text-sm focus:outline-none focus:border-blue-500">
        </div>
        <button onclick="sendTip()" class="w-full btn btn-primary py-2 rounded-lg text-sm font-medium">
            Send Tip
        </button>

        <div id="tipStatus" class="mt-3 text-center text-sm hidden"></div>
    </section>

    <!-- Back Link -->
    <div class="mt-12 text-center">
        <a href="/" class="text-blue-400 hover:text-blue-300 font-medium">
            ← Back to home
        </a>
    </div>
</article>
{% endblock %}

{% block scripts %}
<script>
    const postId = {{ post.id }};
    const addresses = {
        ethereum: '{{ author_eth_address }}',
        avalanche: '{{ author_avax_address }}',
        solana: '{{ author_sol_address }}',
        bitcoin: '{{ author_btc_address }}'
    };

    let selectedCurrency = null;
    let selectedAmount = null;

    function resetTip() {
        selectedCurrency = null;
        selectedAmount = null;
        document.getElementById('tipStatus').classList.add('hidden');
        document.getElementById('customAmount').value = '';
        document.querySelectorAll('.currency-btn').forEach(btn => {
            btn.classList.remove('btn-primary', 'ring-2', 'ring-blue-500');
            btn.classList.add('btn-secondary');
        });
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        });
    }

    function selectCurrency(currency) {
        selectedCurrency = currency;
        document.querySelectorAll('.currency-btn').forEach(btn => {
            btn.classList.remove('btn-primary', 'ring-2', 'ring-blue-500');
            btn.classList.add('btn-secondary');
        });
        const selectedBtn = document.querySelector(`[data-currency="${currency}"]`);
        if (selectedBtn) {
            selectedBtn.classList.remove('btn-secondary');
            selectedBtn.classList.add('btn-primary', 'ring-2', 'ring-blue-500');
        }
        document.getElementById('tipStatus').classList.add('hidden');
    }

    function selectAmount(amount) {
        selectedAmount = amount;
        document.getElementById('customAmount').value = amount;
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        });
        event.target.classList.remove('btn-secondary');
        event.target.classList.add('btn-primary');
    }

    async function sendTip() {
        const statusEl = document.getElementById('tipStatus');
        const customVal = document.getElementById('customAmount').value;
        const amount = customVal ? parseFloat(customVal) : selectedAmount;

        if (!selectedCurrency) {
            statusEl.innerHTML = '<span class="text-red-400">Select currency</span>';
            statusEl.classList.remove('hidden');
            return;
        }

        if (!amount || amount <= 0) {
            statusEl.innerHTML = '<span class="text-red-400">Enter amount</span>';
            statusEl.classList.remove('hidden');
            return;
        }

        // Determine chain
        const chain = selectedCurrency.includes('avax') ? 'avalanche' :
                      selectedCurrency.includes('eth') ? 'ethereum' :
                      selectedCurrency.includes('sol') ? 'solana' : 'bitcoin';

        if (chain === 'bitcoin') {
            const addr = addresses.bitcoin;
            statusEl.innerHTML = `<span class="text-primary-300">Send BTC to:<br><code class="text-xs">${addr}</code></span>`;
            statusEl.classList.remove('hidden');
            return;
        }

        // For EVM chains (Ethereum, Avalanche), use MetaMask directly
        if (chain === 'ethereum' || chain === 'avalanche') {
            if (typeof window.ethereum === 'undefined') {
                statusEl.innerHTML = '<span class="text-yellow-400">Install MetaMask</span>';
                statusEl.classList.remove('hidden');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                statusEl.innerHTML = '<span class="text-blue-400">Connecting...</span>';
                statusEl.classList.remove('hidden');

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const fromAddress = accounts[0];

                // Switch to correct network
                const chainIds = { 'ethereum': '0x1', 'avalanche': '0xa86a' };
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: chainIds[chain] }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902 && chain === 'avalanche') {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0xa86a',
                                chainName: 'Avalanche C-Chain',
                                nativeCurrency: { name: 'AVAX', symbol: 'AVAX', decimals: 18 },
                                rpcUrls: ['https://api.avax.network/ext/bc/C/rpc'],
                                blockExplorerUrls: ['https://snowtrace.io/']
                            }]
                        });
                    }
                }

                statusEl.innerHTML = '<span class="text-blue-400">Confirm in wallet...</span>';

                const recipient = chain === 'ethereum' ? addresses.ethereum : addresses.avalanche;
                const isToken = selectedCurrency.includes('usdt');
                const cryptoAmount = isToken ? amount : (amount / 2500);
                const weiAmount = '0x' + Math.floor(cryptoAmount * 1e18).toString(16);

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: fromAddress,
                        to: recipient,
                        value: weiAmount
                    }]
                });

                if (txHash) {
                    await fetch('/api/tips/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            post_id: postId,
                            from_address: fromAddress,
                            amount: amount.toString(),
                            currency: selectedCurrency.toUpperCase(),
                            chain: chain,
                            tx_hash: txHash
                        })
                    });

                    statusEl.innerHTML = '<span class="text-green-400">Sent! Thank you!</span>';
                    setTimeout(resetTip, 3000);
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-400">${error.message || 'Transaction failed'}</span>`;
            }
            return;
        }

        // For Solana - use Phantom directly, fallback to MetaMask prompt
        if (chain === 'solana') {
            if (typeof window.solana === 'undefined' || !window.solana.isPhantom) {
                // Phantom not available, try to open MetaMask
                if (typeof window.ethereum !== 'undefined') {
                    statusEl.innerHTML = '<span class="text-yellow-400">SOL requires Phantom. Use ETH/AVAX instead.</span>';
                    statusEl.classList.remove('hidden');
                    window.ethereum.request({ method: 'eth_requestAccounts' });
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-400">Install MetaMask or Phantom</span>';
                    statusEl.classList.remove('hidden');
                    window.open('https://metamask.io/download/', '_blank');
                }
                return;
            }

            try {
                statusEl.innerHTML = '<span class="text-blue-400">Connecting...</span>';
                statusEl.classList.remove('hidden');

                // Connect to Phantom
                const response = await window.solana.connect();
                const fromAddress = response.publicKey.toString();

                statusEl.innerHTML = '<span class="text-blue-400">Confirm in wallet...</span>';

                const isToken = selectedCurrency.includes('usdt');
                const cryptoAmount = isToken ? amount : (amount / 150);

                // For native SOL transfer
                const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: response.publicKey,
                        toPubkey: new solanaWeb3.PublicKey(addresses.solana),
                        lamports: Math.floor(cryptoAmount * 1e9)
                    })
                );

                transaction.feePayer = response.publicKey;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                const signed = await window.solana.signTransaction(transaction);
                const txHash = await connection.sendRawTransaction(signed.serialize());

                if (txHash) {
                    await fetch('/api/tips/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            post_id: postId,
                            from_address: fromAddress,
                            amount: amount.toString(),
                            currency: selectedCurrency.toUpperCase(),
                            chain: chain,
                            tx_hash: txHash
                        })
                    });

                    statusEl.innerHTML = '<span class="text-green-400">Sent! Thank you!</span>';
                    setTimeout(resetTip, 3000);
                }
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-400">${error.message || 'Transaction failed'}</span>`;
            }
        }
    }
</script>
{% endblock %}
